//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Users/retechretech/dev/workspace/realtime/realtime-channel/src/main/java/com/goodow/realtime/channel/impl/SimpleBus.java
//
//  Created by retechretech.
//

#include "IOSClass.h"
#include "com/goodow/realtime/channel/Bus.h"
#include "com/goodow/realtime/channel/BusHook.h"
#include "com/goodow/realtime/channel/Message.h"
#include "com/goodow/realtime/channel/State.h"
#include "com/goodow/realtime/channel/impl/MessageImpl.h"
#include "com/goodow/realtime/channel/impl/SimpleBus.h"
#include "com/goodow/realtime/channel/util/IdGenerator.h"
#include "com/goodow/realtime/core/Handler.h"
#include "com/goodow/realtime/core/Platform.h"
#include "com/goodow/realtime/core/Registration.h"
#include "com/goodow/realtime/core/Scheduler.h"
#include "com/goodow/realtime/json/Json.h"
#include "com/goodow/realtime/json/JsonArray.h"
#include "com/goodow/realtime/json/JsonObject.h"
#include "java/lang/IllegalArgumentException.h"
#include "java/lang/Throwable.h"
#include "java/lang/Void.h"
#include "java/util/logging/Level.h"
#include "java/util/logging/Logger.h"

BOOL ComGoodowRealtimeChannelImplSimpleBus_initialized = NO;

@implementation ComGoodowRealtimeChannelImplSimpleBus

JavaUtilLoggingLogger * ComGoodowRealtimeChannelImplSimpleBus_log_;

+ (void)checkNotNullWithNSString:(NSString *)paramName
                          withId:(id)param {
  if (param == nil) {
    @throw [[JavaLangIllegalArgumentException alloc] initWithNSString:[NSString stringWithFormat:@"Parameter %@ must be specified", paramName]];
  }
}

- (id)init {
  if (self = [super init]) {
    handlerMap_ = [ComGoodowRealtimeJsonJson createObject];
    replyHandlers_ = [ComGoodowRealtimeJsonJson createObject];
    idGenerator_ = [[ComGoodowRealtimeChannelUtilIdGenerator alloc] init];
  }
  return self;
}

- (void)close {
  if (hook_ == nil || [hook_ handlePreClose]) {
    [self doClose];
  }
}

- (ComGoodowRealtimeChannelStateEnum *)getReadyState {
  return handlerMap_ == nil ? ComGoodowRealtimeChannelStateEnum_get_CLOSED() : ComGoodowRealtimeChannelStateEnum_get_OPEN();
}

- (NSString *)getSessionId {
  return @"@";
}

- (id<ComGoodowRealtimeChannelBus>)publishWithNSString:(NSString *)topic
                                                withId:(id)msg {
  [self internalHandleSendOrPubWithBoolean:NO withBoolean:NO withNSString:topic withId:msg withComGoodowRealtimeCoreHandler:nil];
  return self;
}

- (id<ComGoodowRealtimeChannelBus>)publishLocalWithNSString:(NSString *)topic
                                                     withId:(id)msg {
  [self internalHandleSendOrPubWithBoolean:YES withBoolean:NO withNSString:topic withId:msg withComGoodowRealtimeCoreHandler:nil];
  return self;
}

- (id<ComGoodowRealtimeCoreRegistration>)subscribeWithNSString:(NSString *)topic
                              withComGoodowRealtimeCoreHandler:(id<ComGoodowRealtimeCoreHandler>)handler {
  return [self subscribeImplWithBoolean:NO withNSString:topic withComGoodowRealtimeCoreHandler:handler];
}

- (id<ComGoodowRealtimeCoreRegistration>)subscribeLocalWithNSString:(NSString *)topic
                                   withComGoodowRealtimeCoreHandler:(id<ComGoodowRealtimeCoreHandler>)handler {
  return [self subscribeImplWithBoolean:YES withNSString:topic withComGoodowRealtimeCoreHandler:handler];
}

- (id<ComGoodowRealtimeChannelBus>)sendWithNSString:(NSString *)topic
                                             withId:(id)msg
                   withComGoodowRealtimeCoreHandler:(id<ComGoodowRealtimeCoreHandler>)replyHandler {
  [self internalHandleSendOrPubWithBoolean:NO withBoolean:YES withNSString:topic withId:msg withComGoodowRealtimeCoreHandler:replyHandler];
  return self;
}

- (id<ComGoodowRealtimeChannelBus>)sendLocalWithNSString:(NSString *)topic
                                                  withId:(id)msg
                        withComGoodowRealtimeCoreHandler:(id<ComGoodowRealtimeCoreHandler>)replyHandler {
  [self internalHandleSendOrPubWithBoolean:YES withBoolean:YES withNSString:topic withId:msg withComGoodowRealtimeCoreHandler:replyHandler];
  return self;
}

- (id<ComGoodowRealtimeChannelBus>)setHookWithComGoodowRealtimeChannelBusHook:(id<ComGoodowRealtimeChannelBusHook>)hook {
  self->hook_ = hook;
  return self;
}

- (void)doClose {
  (void) [self publishLocalWithNSString:ComGoodowRealtimeChannelBus_get_ON_CLOSE_() withId:nil];
  [self clearHandlers];
  if (hook_ != nil) {
    [hook_ handlePostClose];
  }
}

- (BOOL)doSubscribeWithBoolean:(BOOL)local
                  withNSString:(NSString *)topic
withComGoodowRealtimeCoreHandler:(id<ComGoodowRealtimeCoreHandler>)handler {
  [ComGoodowRealtimeChannelImplSimpleBus checkNotNullWithNSString:@"topic" withId:topic];
  [ComGoodowRealtimeChannelImplSimpleBus checkNotNullWithNSString:@"handler" withId:handler];
  id<ComGoodowRealtimeJsonJsonArray> handlers = [((id<ComGoodowRealtimeJsonJsonObject>) nil_chk(handlerMap_)) getArrayWithNSString:topic];
  if (handlers == nil) {
    (void) [handlerMap_ setWithNSString:topic withId:[((id<ComGoodowRealtimeJsonJsonArray>) nil_chk([ComGoodowRealtimeJsonJson createArray])) pushWithId:handler]];
    return YES;
  }
  if ([((id<ComGoodowRealtimeJsonJsonArray>) nil_chk(handlers)) indexOfWithId:handler] == -1) {
    (void) [handlers pushWithId:handler];
    return YES;
  }
  return NO;
}

- (void)doSendOrPubWithBoolean:(BOOL)local
                   withBoolean:(BOOL)send
                  withNSString:(NSString *)topic
                        withId:(id)msg
withComGoodowRealtimeCoreHandler:(id<ComGoodowRealtimeCoreHandler>)replyHandler {
  [ComGoodowRealtimeChannelImplSimpleBus checkNotNullWithNSString:@"topic" withId:topic];
  NSString *replyTopic = nil;
  if (replyHandler != nil) {
    replyTopic = [self makeUUID];
  }
  ComGoodowRealtimeChannelImplMessageImpl *message = [[ComGoodowRealtimeChannelImplMessageImpl alloc] initWithBoolean:local withBoolean:send withComGoodowRealtimeChannelBus:self withNSString:topic withNSString:replyTopic withId:msg];
  if ([self internalHandleReceiveMessageWithBoolean:local withComGoodowRealtimeChannelMessage:message] && replyHandler != nil) {
    (void) [((id<ComGoodowRealtimeJsonJsonObject>) nil_chk(replyHandlers_)) setWithNSString:replyTopic withId:replyHandler];
  }
}

- (BOOL)doUnsubscribeWithBoolean:(BOOL)local
                    withNSString:(NSString *)topic
withComGoodowRealtimeCoreHandler:(id<ComGoodowRealtimeCoreHandler>)handler {
  [ComGoodowRealtimeChannelImplSimpleBus checkNotNullWithNSString:@"topic" withId:topic];
  [ComGoodowRealtimeChannelImplSimpleBus checkNotNullWithNSString:@"handler" withId:handler];
  id<ComGoodowRealtimeJsonJsonArray> handlers = [((id<ComGoodowRealtimeJsonJsonObject>) nil_chk(handlerMap_)) getArrayWithNSString:topic];
  if (handlers == nil) {
    return NO;
  }
  BOOL removed = [((id<ComGoodowRealtimeJsonJsonArray>) nil_chk(handlers)) removeValueWithId:handler];
  if ([handlers length] == 0) {
    (void) [handlerMap_ removeWithNSString:topic];
  }
  return removed;
}

- (void)clearHandlers {
  (void) [((id<ComGoodowRealtimeJsonJsonObject>) nil_chk(replyHandlers_)) clear];
  (void) [((id<ComGoodowRealtimeJsonJsonObject>) nil_chk(handlerMap_)) clear];
  handlerMap_ = nil;
}

- (BOOL)internalHandleReceiveMessageWithBoolean:(BOOL)local
            withComGoodowRealtimeChannelMessage:(id<ComGoodowRealtimeChannelMessage>)message {
  if (local || hook_ == nil || [hook_ handleReceiveMessageWithComGoodowRealtimeChannelMessage:message]) {
    [self doReceiveMessageWithComGoodowRealtimeChannelMessage:message];
    return YES;
  }
  return NO;
}

- (void)internalHandleSendOrPubWithBoolean:(BOOL)local
                               withBoolean:(BOOL)send
                              withNSString:(NSString *)topic
                                    withId:(id)msg
          withComGoodowRealtimeCoreHandler:(id<ComGoodowRealtimeCoreHandler>)replyHandler {
  if (local || hook_ == nil || [hook_ handleSendOrPubWithBoolean:send withNSString:topic withId:msg withComGoodowRealtimeCoreHandler:replyHandler]) {
    [self doSendOrPubWithBoolean:local withBoolean:send withNSString:topic withId:msg withComGoodowRealtimeCoreHandler:replyHandler];
  }
}

- (NSString *)makeUUID {
  return [((ComGoodowRealtimeChannelUtilIdGenerator *) nil_chk(idGenerator_)) nextWithInt:36];
}

- (void)scheduleHandleWithNSString:(NSString *)topic
                            withId:(id)handler
                            withId:(id)message {
  [((id<ComGoodowRealtimeCoreScheduler>) nil_chk([ComGoodowRealtimeCorePlatform scheduler])) scheduleDeferredWithComGoodowRealtimeCoreHandler:[[ComGoodowRealtimeChannelImplSimpleBus_$1 alloc] initWithComGoodowRealtimeChannelImplSimpleBus:self withId:handler withId:message withNSString:topic]];
}

- (void)doReceiveMessageWithComGoodowRealtimeChannelMessage:(id<ComGoodowRealtimeChannelMessage>)message {
  NSString *topic = [((id<ComGoodowRealtimeChannelMessage>) nil_chk(message)) topic];
  id<ComGoodowRealtimeJsonJsonArray> handlers = [((id<ComGoodowRealtimeJsonJsonObject>) nil_chk(handlerMap_)) getArrayWithNSString:topic];
  if (handlers != nil) {
    [handlers forEachWithComGoodowRealtimeJsonJsonArray_ListIterator:[[ComGoodowRealtimeChannelImplSimpleBus_$2 alloc] initWithComGoodowRealtimeChannelImplSimpleBus:self withNSString:topic withComGoodowRealtimeChannelMessage:message]];
  }
  else {
    id handler = [((id<ComGoodowRealtimeJsonJsonObject>) nil_chk(replyHandlers_)) getWithNSString:topic];
    if (handler != nil) {
      (void) [replyHandlers_ removeWithNSString:topic];
      [self scheduleHandleWithNSString:topic withId:handler withId:message];
    }
  }
}

- (id<ComGoodowRealtimeCoreRegistration>)subscribeImplWithBoolean:(BOOL)local
                                                     withNSString:(NSString *)topic
                                 withComGoodowRealtimeCoreHandler:(id<ComGoodowRealtimeCoreHandler>)handler {
  [self doSubscribeWithBoolean:local withNSString:topic withComGoodowRealtimeCoreHandler:handler];
  return [[ComGoodowRealtimeChannelImplSimpleBus_$3 alloc] initWithComGoodowRealtimeChannelImplSimpleBus:self withBoolean:local withNSString:topic withComGoodowRealtimeCoreHandler:handler];
}

+ (void)initialize {
  if (self == [ComGoodowRealtimeChannelImplSimpleBus class]) {
    ComGoodowRealtimeChannelImplSimpleBus_log_ = [JavaUtilLoggingLogger getLoggerWithNSString:[[IOSClass classWithClass:[ComGoodowRealtimeChannelImplSimpleBus class]] getName]];
    ComGoodowRealtimeChannelImplSimpleBus_initialized = YES;
  }
}

- (void)copyAllFieldsTo:(ComGoodowRealtimeChannelImplSimpleBus *)other {
  [super copyAllFieldsTo:other];
  other->handlerMap_ = handlerMap_;
  other->hook_ = hook_;
  other->idGenerator_ = idGenerator_;
  other->replyHandlers_ = replyHandlers_;
}

+ (J2ObjcClassInfo *)__metadata {
  static J2ObjcMethodInfo methods[] = {
    { "checkNotNullWithNSString:withId:", "checkNotNull", "V", 0x8, NULL },
    { "init", "SimpleBus", NULL, 0x1, NULL },
    { "close", NULL, "V", 0x1, NULL },
    { "getReadyState", NULL, "Lcom.goodow.realtime.channel.State;", 0x1, NULL },
    { "getSessionId", NULL, "Ljava.lang.String;", 0x1, NULL },
    { "publishWithNSString:withId:", "publish", "Lcom.goodow.realtime.channel.Bus;", 0x1, NULL },
    { "publishLocalWithNSString:withId:", "publishLocal", "Lcom.goodow.realtime.channel.Bus;", 0x1, NULL },
    { "subscribeWithNSString:withComGoodowRealtimeCoreHandler:", "subscribe", "Lcom.goodow.realtime.core.Registration;", 0x1, NULL },
    { "subscribeLocalWithNSString:withComGoodowRealtimeCoreHandler:", "subscribeLocal", "Lcom.goodow.realtime.core.Registration;", 0x1, NULL },
    { "sendWithNSString:withId:withComGoodowRealtimeCoreHandler:", "send", "Lcom.goodow.realtime.channel.Bus;", 0x1, NULL },
    { "sendLocalWithNSString:withId:withComGoodowRealtimeCoreHandler:", "sendLocal", "Lcom.goodow.realtime.channel.Bus;", 0x1, NULL },
    { "setHookWithComGoodowRealtimeChannelBusHook:", "setHook", "Lcom.goodow.realtime.channel.Bus;", 0x1, NULL },
    { "doClose", NULL, "V", 0x4, NULL },
    { "doSubscribeWithBoolean:withNSString:withComGoodowRealtimeCoreHandler:", "doSubscribe", "Z", 0x4, NULL },
    { "doSendOrPubWithBoolean:withBoolean:withNSString:withId:withComGoodowRealtimeCoreHandler:", "doSendOrPub", "V", 0x4, NULL },
    { "doUnsubscribeWithBoolean:withNSString:withComGoodowRealtimeCoreHandler:", "doUnsubscribe", "Z", 0x4, NULL },
    { "clearHandlers", NULL, "V", 0x0, NULL },
    { "internalHandleReceiveMessageWithBoolean:withComGoodowRealtimeChannelMessage:", "internalHandleReceiveMessage", "Z", 0x0, NULL },
    { "internalHandleSendOrPubWithBoolean:withBoolean:withNSString:withId:withComGoodowRealtimeCoreHandler:", "internalHandleSendOrPub", "V", 0x0, NULL },
    { "makeUUID", NULL, "Ljava.lang.String;", 0x0, NULL },
    { "scheduleHandleWithNSString:withId:withId:", "scheduleHandle", "V", 0x0, NULL },
    { "doReceiveMessageWithComGoodowRealtimeChannelMessage:", "doReceiveMessage", "V", 0x2, NULL },
    { "subscribeImplWithBoolean:withNSString:withComGoodowRealtimeCoreHandler:", "subscribeImpl", "Lcom.goodow.realtime.core.Registration;", 0x2, NULL },
  };
  static J2ObjcFieldInfo fields[] = {
    { "log_", NULL, 0x1a, "Ljava.util.logging.Logger;", &ComGoodowRealtimeChannelImplSimpleBus_log_,  },
    { "handlerMap_", NULL, 0x2, "Lcom.goodow.realtime.json.JsonObject;", NULL,  },
    { "replyHandlers_", NULL, 0x10, "Lcom.goodow.realtime.json.JsonObject;", NULL,  },
    { "hook_", NULL, 0x0, "Lcom.goodow.realtime.channel.BusHook;", NULL,  },
    { "idGenerator_", NULL, 0x10, "Lcom.goodow.realtime.channel.util.IdGenerator;", NULL,  },
  };
  static J2ObjcClassInfo _ComGoodowRealtimeChannelImplSimpleBus = { "SimpleBus", "com.goodow.realtime.channel.impl", NULL, 0x1, 23, methods, 5, fields, 0, NULL};
  return &_ComGoodowRealtimeChannelImplSimpleBus;
}

@end

@implementation ComGoodowRealtimeChannelImplSimpleBus_$1

- (void)handleWithId:(id)ignore {
  @try {
    [((id<ComGoodowRealtimeCoreScheduler>) nil_chk([ComGoodowRealtimeCorePlatform scheduler])) handleWithId:val$handler_ withId:val$message_];
  }
  @catch (JavaLangThrowable *e) {
    [((JavaUtilLoggingLogger *) nil_chk(ComGoodowRealtimeChannelImplSimpleBus_get_log_())) logWithJavaUtilLoggingLevel:JavaUtilLoggingLevel_get_WARNING_() withNSString:[NSString stringWithFormat:@"Failed to handle on topic: %@", val$topic_] withJavaLangThrowable:e];
    (void) [this$0_ publishLocalWithNSString:ComGoodowRealtimeChannelBus_get_ON_ERROR_() withId:[((id<ComGoodowRealtimeJsonJsonObject>) nil_chk([((id<ComGoodowRealtimeJsonJsonObject>) nil_chk([((id<ComGoodowRealtimeJsonJsonObject>) nil_chk([ComGoodowRealtimeJsonJson createObject])) setWithNSString:@"topic" withId:val$topic_])) setWithNSString:@"message" withId:val$message_])) setWithNSString:@"cause" withId:e]];
  }
}

- (id)initWithComGoodowRealtimeChannelImplSimpleBus:(ComGoodowRealtimeChannelImplSimpleBus *)outer$
                                             withId:(id)capture$0
                                             withId:(id)capture$1
                                       withNSString:(NSString *)capture$2 {
  this$0_ = outer$;
  val$handler_ = capture$0;
  val$message_ = capture$1;
  val$topic_ = capture$2;
  return [super init];
}

+ (J2ObjcClassInfo *)__metadata {
  static J2ObjcMethodInfo methods[] = {
    { "handleWithJavaLangVoid:", "handle", "V", 0x1, NULL },
    { "initWithComGoodowRealtimeChannelImplSimpleBus:withId:withId:withNSString:", "init", NULL, 0x0, NULL },
  };
  static J2ObjcFieldInfo fields[] = {
    { "this$0_", NULL, 0x1012, "Lcom.goodow.realtime.channel.impl.SimpleBus;", NULL,  },
    { "val$handler_", NULL, 0x1012, "Ljava.lang.Object;", NULL,  },
    { "val$message_", NULL, 0x1012, "Ljava.lang.Object;", NULL,  },
    { "val$topic_", NULL, 0x1012, "Ljava.lang.String;", NULL,  },
  };
  static J2ObjcClassInfo _ComGoodowRealtimeChannelImplSimpleBus_$1 = { "$1", "com.goodow.realtime.channel.impl", "SimpleBus", 0x8000, 2, methods, 4, fields, 0, NULL};
  return &_ComGoodowRealtimeChannelImplSimpleBus_$1;
}

@end

@implementation ComGoodowRealtimeChannelImplSimpleBus_$2

- (void)callWithInt:(int)index
             withId:(id)value {
  [this$0_ scheduleHandleWithNSString:val$topic_ withId:value withId:val$message_];
}

- (id)initWithComGoodowRealtimeChannelImplSimpleBus:(ComGoodowRealtimeChannelImplSimpleBus *)outer$
                                       withNSString:(NSString *)capture$0
                withComGoodowRealtimeChannelMessage:(id<ComGoodowRealtimeChannelMessage>)capture$1 {
  this$0_ = outer$;
  val$topic_ = capture$0;
  val$message_ = capture$1;
  return [super init];
}

+ (J2ObjcClassInfo *)__metadata {
  static J2ObjcMethodInfo methods[] = {
    { "callWithInt:withId:", "call", "V", 0x1, NULL },
    { "initWithComGoodowRealtimeChannelImplSimpleBus:withNSString:withComGoodowRealtimeChannelMessage:", "init", NULL, 0x0, NULL },
  };
  static J2ObjcFieldInfo fields[] = {
    { "this$0_", NULL, 0x1012, "Lcom.goodow.realtime.channel.impl.SimpleBus;", NULL,  },
    { "val$topic_", NULL, 0x1012, "Ljava.lang.String;", NULL,  },
    { "val$message_", NULL, 0x1012, "Lcom.goodow.realtime.channel.Message;", NULL,  },
  };
  static J2ObjcClassInfo _ComGoodowRealtimeChannelImplSimpleBus_$2 = { "$2", "com.goodow.realtime.channel.impl", "SimpleBus", 0x8000, 2, methods, 3, fields, 0, NULL};
  return &_ComGoodowRealtimeChannelImplSimpleBus_$2;
}

@end

@implementation ComGoodowRealtimeChannelImplSimpleBus_$3

- (void)unregister {
  [this$0_ doUnsubscribeWithBoolean:val$local_ withNSString:val$topic_ withComGoodowRealtimeCoreHandler:val$handler_];
}

- (id)initWithComGoodowRealtimeChannelImplSimpleBus:(ComGoodowRealtimeChannelImplSimpleBus *)outer$
                                        withBoolean:(BOOL)capture$0
                                       withNSString:(NSString *)capture$1
                   withComGoodowRealtimeCoreHandler:(id<ComGoodowRealtimeCoreHandler>)capture$2 {
  this$0_ = outer$;
  val$local_ = capture$0;
  val$topic_ = capture$1;
  val$handler_ = capture$2;
  return [super init];
}

+ (J2ObjcClassInfo *)__metadata {
  static J2ObjcMethodInfo methods[] = {
    { "unregister", NULL, "V", 0x1, NULL },
    { "initWithComGoodowRealtimeChannelImplSimpleBus:withBoolean:withNSString:withComGoodowRealtimeCoreHandler:", "init", NULL, 0x0, NULL },
  };
  static J2ObjcFieldInfo fields[] = {
    { "this$0_", NULL, 0x1012, "Lcom.goodow.realtime.channel.impl.SimpleBus;", NULL,  },
    { "val$local_", NULL, 0x1012, "Z", NULL,  },
    { "val$topic_", NULL, 0x1012, "Ljava.lang.String;", NULL,  },
    { "val$handler_", NULL, 0x1012, "Lcom.goodow.realtime.core.Handler;", NULL,  },
  };
  static J2ObjcClassInfo _ComGoodowRealtimeChannelImplSimpleBus_$3 = { "$3", "com.goodow.realtime.channel.impl", "SimpleBus", 0x8000, 2, methods, 4, fields, 0, NULL};
  return &_ComGoodowRealtimeChannelImplSimpleBus_$3;
}

@end
