//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Users/retechretech/dev/workspace/realtime/realtime-channel/src/main/java/com/goodow/realtime/channel/impl/ReconnectBusClient.java
//
//  Created by retechretech.
//

#include "IOSObjectArray.h"
#include "com/goodow/realtime/channel/BusHook.h"
#include "com/goodow/realtime/channel/State.h"
#include "com/goodow/realtime/channel/impl/ReconnectBusClient.h"
#include "com/goodow/realtime/channel/impl/SimpleBus.h"
#include "com/goodow/realtime/channel/impl/WebSocketBusClient.h"
#include "com/goodow/realtime/channel/util/FuzzingBackOffGenerator.h"
#include "com/goodow/realtime/core/Handler.h"
#include "com/goodow/realtime/core/Platform.h"
#include "com/goodow/realtime/core/Scheduler.h"
#include "com/goodow/realtime/core/WebSocket.h"
#include "com/goodow/realtime/json/Json.h"
#include "com/goodow/realtime/json/JsonArray.h"
#include "com/goodow/realtime/json/JsonObject.h"
#include "java/lang/Void.h"

@implementation GDCReconnectBusClient

static NSString * GDCReconnectBusClient_AUTO_RECONNECT_ = @"reconnect";

+ (NSString *)AUTO_RECONNECT {
  return GDCReconnectBusClient_AUTO_RECONNECT_;
}

- (id)initWithNSString:(NSString *)url
      withGDJsonObject:(id<GDJsonObject>)options {
  if (self = [super initWithNSString:url withGDJsonObject:options]) {
    queuedMessages_ = [GDJson createArray];
    backOffGenerator_ = [[ComGoodowRealtimeChannelUtilFuzzingBackOffGenerator alloc] initWithInt:1 * 1000 withInt:30 * 60 * 1000 withDouble:0.5];
    (void) [super setHookWithGDCBusHook:[[GDCReconnectBusClient_$1 alloc] initWithGDCReconnectBusClient:self]];
  }
  return self;
}

- (void)reconnect {
  if (state_ == [GDCStateEnum OPEN]) {
    return;
  }
  if (webSocket_ != nil) {
    [webSocket_ close];
  }
  [self connectWithNSString:url_ withGDJsonObject:[self getOptions]];
}

- (GDCSimpleBus *)setHookWithGDCBusHook:(id<GDCBusHook>)hook {
  self->hook_ReconnectBusClient_ = hook;
  return self;
}

- (void)setOptionsWithGDJsonObject:(id<GDJsonObject>)options {
  [super setOptionsWithGDJsonObject:options];
  reconnect__ = options == nil || ![options has:GDCReconnectBusClient_AUTO_RECONNECT_] ? YES : [options getBoolean:GDCReconnectBusClient_AUTO_RECONNECT_];
}

- (void)doClose {
  reconnect__ = NO;
  (void) [((id<GDJsonArray>) nil_chk(queuedMessages_)) clear];
  [super doClose];
}

- (void)copyAllFieldsTo:(GDCReconnectBusClient *)other {
  [super copyAllFieldsTo:other];
  other->backOffGenerator_ = backOffGenerator_;
  other->hook_ReconnectBusClient_ = hook_ReconnectBusClient_;
  other->queuedMessages_ = queuedMessages_;
  other->reconnect__ = reconnect__;
}

+ (J2ObjcClassInfo *)__metadata {
  static J2ObjcMethodInfo methods[] = {
    { "initWithNSString:withGDJsonObject:", "ReconnectBusClient", NULL, 0x1, NULL },
    { "reconnect", NULL, "V", 0x1, NULL },
    { "setHookWithGDCBusHook:", "setHook", "Lcom.goodow.realtime.channel.impl.SimpleBus;", 0x1, NULL },
    { "setOptionsWithGDJsonObject:", "setOptions", "V", 0x1, NULL },
    { "doClose", NULL, "V", 0x4, NULL },
  };
  static J2ObjcFieldInfo fields[] = {
    { "AUTO_RECONNECT_", NULL, 0x19, "Ljava.lang.String;" },
    { "backOffGenerator_", NULL, 0x12, "Lcom.goodow.realtime.channel.util.FuzzingBackOffGenerator;" },
    { "hook_ReconnectBusClient_", "hook", 0x2, "Lcom.goodow.realtime.channel.BusHook;" },
    { "reconnect__", "reconnect", 0x2, "Z" },
    { "queuedMessages_", NULL, 0x12, "Lcom.goodow.realtime.json.JsonArray;" },
  };
  static J2ObjcClassInfo _GDCReconnectBusClient = { "ReconnectBusClient", "com.goodow.realtime.channel.impl", NULL, 0x1, 5, methods, 5, fields, 0, NULL};
  return &_GDCReconnectBusClient;
}

@end
@implementation GDCReconnectBusClient_QueuedMessage

- (id)initWithGDCReconnectBusClient:(GDCReconnectBusClient *)outer$
                        withBoolean:(BOOL)send
                       withNSString:(NSString *)address
                             withId:(id)msg
   withComGoodowRealtimeCoreHandler:(id<ComGoodowRealtimeCoreHandler>)replyHandler {
  if (self = [super init]) {
    self->send_ = send;
    self->address_ = address;
    self->msg_ = msg;
    self->replyHandler_ = replyHandler;
  }
  return self;
}

- (void)copyAllFieldsTo:(GDCReconnectBusClient_QueuedMessage *)other {
  [super copyAllFieldsTo:other];
  other->address_ = address_;
  other->msg_ = msg_;
  other->replyHandler_ = replyHandler_;
  other->send_ = send_;
}

+ (J2ObjcClassInfo *)__metadata {
  static J2ObjcMethodInfo methods[] = {
    { "initWithGDCReconnectBusClient:withBoolean:withNSString:withId:withComGoodowRealtimeCoreHandler:", "QueuedMessage", NULL, 0x0, NULL },
  };
  static J2ObjcFieldInfo fields[] = {
    { "send_", NULL, 0x10, "Z" },
    { "address_", NULL, 0x10, "Ljava.lang.String;" },
    { "msg_", NULL, 0x10, "Ljava.lang.Object;" },
    { "replyHandler_", NULL, 0x10, "Lcom.goodow.realtime.core.Handler;" },
  };
  static J2ObjcClassInfo _GDCReconnectBusClient_QueuedMessage = { "QueuedMessage", "com.goodow.realtime.channel.impl", "ReconnectBusClient", 0x2, 1, methods, 4, fields, 0, NULL};
  return &_GDCReconnectBusClient_QueuedMessage;
}

@end
@implementation GDCReconnectBusClient_$1

- (void)handleOpened {
  [((ComGoodowRealtimeChannelUtilFuzzingBackOffGenerator *) nil_chk(this$0_->backOffGenerator_)) reset];
  IOSObjectArray *addresses = [((id<GDJsonObject>) nil_chk(this$0_->handlerMap_)) keys];
  {
    IOSObjectArray *a__ = addresses;
    NSString * const *b__ = ((IOSObjectArray *) nil_chk(a__))->buffer_;
    NSString * const *e__ = b__ + a__->size_;
    while (b__ < e__) {
      NSString *address = (*b__++);
      NSAssert([((id<GDJsonArray>) nil_chk([this$0_->handlerMap_ getArray:address])) count] > 0, [[NSString stringWithFormat:@"Handlers registried on %@ shouldn't be empty" J2OBJC_COMMA() address] description]);
      if (![this$0_ isLocalForkWithNSString:address]) {
        [this$0_ sendRegisterWithNSString:address];
      }
    }
  }
  if ([((id<GDJsonArray>) nil_chk(this$0_->queuedMessages_)) count] != 0) {
    [this$0_->queuedMessages_ forEach:[[GDCReconnectBusClient_$1_$1 alloc] initWithGDCReconnectBusClient_$1:self]];
    (void) [this$0_->queuedMessages_ clear];
  }
  [super handleOpened];
}

- (void)handlePostClose {
  if (this$0_->reconnect__) {
    [((id<ComGoodowRealtimeCoreScheduler>) nil_chk([ComGoodowRealtimeCorePlatform scheduler])) scheduleDelayWithInt:((ComGoodowRealtimeChannelUtilFuzzingBackOffGenerator_BackOffParameters *) nil_chk([((ComGoodowRealtimeChannelUtilFuzzingBackOffGenerator *) nil_chk(this$0_->backOffGenerator_)) next]))->targetDelay_ withComGoodowRealtimeCoreHandler:[[GDCReconnectBusClient_$1_$2 alloc] initWithGDCReconnectBusClient_$1:self]];
  }
  [super handlePostClose];
}

- (BOOL)handleSendOrPubWithBoolean:(BOOL)send
                      withNSString:(NSString *)address
                            withId:(id)msg
  withComGoodowRealtimeCoreHandler:(id<ComGoodowRealtimeCoreHandler>)replyHandler {
  BOOL allow = [super handleSendOrPubWithBoolean:send withNSString:address withId:msg withComGoodowRealtimeCoreHandler:replyHandler];
  if (!allow || this$0_->state_ == [GDCStateEnum OPEN] || [this$0_ isLocalForkWithNSString:address]) {
    return allow;
  }
  (void) [((id<GDJsonArray>) nil_chk(this$0_->queuedMessages_)) push:[[GDCReconnectBusClient_QueuedMessage alloc] initWithGDCReconnectBusClient:this$0_ withBoolean:send withNSString:address withId:msg withComGoodowRealtimeCoreHandler:replyHandler]];
  return NO;
}

- (id<GDCBusHook>)delegate {
  return this$0_->hook_ReconnectBusClient_;
}

- (id)initWithGDCReconnectBusClient:(GDCReconnectBusClient *)outer$ {
  this$0_ = outer$;
  return [super init];
}

+ (J2ObjcClassInfo *)__metadata {
  static J2ObjcMethodInfo methods[] = {
    { "handleOpened", NULL, "V", 0x1, NULL },
    { "handlePostClose", NULL, "V", 0x1, NULL },
    { "handleSendOrPubWithBoolean:withNSString:withId:withComGoodowRealtimeCoreHandler:", "handleSendOrPub", "Z", 0x1, NULL },
    { "delegate", NULL, "Lcom.goodow.realtime.channel.BusHook;", 0x4, NULL },
    { "initWithGDCReconnectBusClient:", "init", NULL, 0x0, NULL },
  };
  static J2ObjcFieldInfo fields[] = {
    { "this$0_", NULL, 0x1012, "Lcom.goodow.realtime.channel.impl.ReconnectBusClient;" },
  };
  static J2ObjcClassInfo _GDCReconnectBusClient_$1 = { "$1", "com.goodow.realtime.channel.impl", "ReconnectBusClient", 0x8000, 5, methods, 1, fields, 0, NULL};
  return &_GDCReconnectBusClient_$1;
}

@end
@implementation GDCReconnectBusClient_$1_$1

- (void)callWithInt:(int)index
             withId:(GDCReconnectBusClient_QueuedMessage *)value {
  [this$0_->this$0_ doSendOrPubWithBoolean:((GDCReconnectBusClient_QueuedMessage *) nil_chk(value))->send_ withNSString:value->address_ withId:value->msg_ withComGoodowRealtimeCoreHandler:value->replyHandler_];
}

- (id)initWithGDCReconnectBusClient_$1:(GDCReconnectBusClient_$1 *)outer$ {
  this$0_ = outer$;
  return [super init];
}

+ (J2ObjcClassInfo *)__metadata {
  static J2ObjcMethodInfo methods[] = {
    { "callWithInt:withGDCReconnectBusClient_QueuedMessage:", "call", "V", 0x1, NULL },
    { "initWithGDCReconnectBusClient_$1:", "init", NULL, 0x0, NULL },
  };
  static J2ObjcFieldInfo fields[] = {
    { "this$0_", NULL, 0x1012, "Lcom.goodow.realtime.channel.impl.ReconnectBusClient$1;" },
  };
  static J2ObjcClassInfo _GDCReconnectBusClient_$1_$1 = { "$1", "com.goodow.realtime.channel.impl", "ReconnectBusClient$$1", 0x8000, 2, methods, 1, fields, 0, NULL};
  return &_GDCReconnectBusClient_$1_$1;
}

@end
@implementation GDCReconnectBusClient_$1_$2

- (void)handleWithId:(id)event {
  if (this$0_->this$0_->reconnect__) {
    [this$0_->this$0_ reconnect];
  }
}

- (id)initWithGDCReconnectBusClient_$1:(GDCReconnectBusClient_$1 *)outer$ {
  this$0_ = outer$;
  return [super init];
}

+ (J2ObjcClassInfo *)__metadata {
  static J2ObjcMethodInfo methods[] = {
    { "handleWithJavaLangVoid:", "handle", "V", 0x1, NULL },
    { "initWithGDCReconnectBusClient_$1:", "init", NULL, 0x0, NULL },
  };
  static J2ObjcFieldInfo fields[] = {
    { "this$0_", NULL, 0x1012, "Lcom.goodow.realtime.channel.impl.ReconnectBusClient$1;" },
  };
  static J2ObjcClassInfo _GDCReconnectBusClient_$1_$2 = { "$2", "com.goodow.realtime.channel.impl", "ReconnectBusClient$$1", 0x8000, 2, methods, 1, fields, 0, NULL};
  return &_GDCReconnectBusClient_$1_$2;
}

@end
